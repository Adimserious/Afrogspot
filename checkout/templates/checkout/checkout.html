{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Checkout</h2>

    {% if messages %}
    <div class="alert-container mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if cart_items %}
    <!-- Display Cart Items Summary -->
    <div class="table-responsive">
        <h4>Your Order Summary ({{ product_count }})</h4>
        <table class="table table-hover align-middle">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Product</th>
                    <th scope="col">Name</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Price</th>
                    <th scope="col">Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in cart_items %}
                <tr>
                    <td><img class="img-fluid rounded" src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                            style="width: 50px;"></td>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>€{{ item.price|floatformat:2 }}</td>
                    <td>€{{ item.total_price|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Cart Totals Section -->
        <div class="cart-totals">
            <p><strong>Subtotal: €{{ total|floatformat:2 }}</strong></p>
            <p><strong>Delivery: €{{ delivery|floatformat:2 }}</strong></p>
            <h4><strong>Grand Total: €{{ grand_total|floatformat:2 }}</strong></h4>
        </div>
    </div>
    {% else %}
    <p>Your cart is empty. Please add items to your cart before proceeding to checkout.</p>
    {% endif %}

    <p>Plese fill out the form to complete your order</p>
    <form id="payment-form" method="post" action="{% url 'checkout' %}">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.full_name.id_for_label }}">Full Name</label>
                    {{ form.full_name }}
                    {% if form.full_name.errors %}
                    <div class="invalid-feedback">
                        {{ form.full_name.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.email.id_for_label }}">Email Address</label>
                    {{ form.email }}
                    {% if form.email.errors %}
                    <div class="invalid-feedback">
                        {{ form.email.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.phone_number.id_for_label }}">Phone Number</label>
                    {{ form.phone_number }}
                    {% if form.phone_number.errors %}
                    <div class="invalid-feedback">
                        {{ form.phone_number.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.address_line_1.id_for_label }}">Address Line 1</label>
                    {{ form.address_line_1 }}
                    {% if form.address_line_1.errors %}
                    <div class="invalid-feedback">
                        {{ form.address_line_1.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.address_line_2.id_for_label }}">Address Line 2</label>
                    {{ form.address_line_2 }}
                    {% if form.address_line_2.errors %}
                    <div class="invalid-feedback">
                        {{ form.address_line_2.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.city.id_for_label }}">City</label>
                    {{ form.city }}
                    {% if form.city.errors %}
                    <div class="invalid-feedback">
                        {{ form.city.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.postal_code.id_for_label }}">Postal Code</label>
                    {{ form.postal_code }}
                    {% if form.postal_code.errors %}
                    <div class="invalid-feedback">
                        {{ form.postal_code.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            <!-- Used chat gpt to generate these countries -->
            <div class="col-md-6 mb-3">
                <div class="form-group">
                    <label for="{{ form.country.id_for_label }}">Country</label>
                    <select name="country" id="id_country" class="form-control">
                        <option value="AF">Afghanistan</option>
                        <option value="AL">Albania</option>
                        <option value="DZ">Algeria</option>
                        <option value="AD">Andorra</option>
                        <option value="AO">Angola</option>
                        <option value="AG">Antigua and Barbuda</option>
                        <option value="AR">Argentina</option>
                        <option value="AM">Armenia</option>
                        <option value="AU">Australia</option>
                        <option value="AT">Austria</option>
                        <option value="AZ">Azerbaijan</option>
                        <option value="BS">Bahamas</option>
                        <option value="BH">Bahrain</option>
                        <option value="BD">Bangladesh</option>
                        <option value="BB">Barbados</option>
                        <option value="BY">Belarus</option>
                        <option value="BE">Belgium</option>
                        <option value="BZ">Belize</option>
                        <option value="BJ">Benin</option>
                        <option value="BT">Bhutan</option>
                        <option value="BO">Bolivia</option>
                        <option value="BA">Bosnia and Herzegovina</option>
                        <option value="BW">Botswana</option>
                        <option value="BR">Brazil</option>
                        <option value="BN">Brunei Darussalam</option>
                        <option value="BG">Bulgaria</option>
                        <option value="BF">Burkina Faso</option>
                        <option value="BI">Burundi</option>
                        <option value="CV">Cabo Verde</option>
                        <option value="KH">Cambodia</option>
                        <option value="CM">Cameroon</option>
                        <option value="CA">Canada</option>
                        <option value="CF">Central African Republic</option>
                        <option value="TD">Chad</option>
                        <option value="CL">Chile</option>
                        <option value="CN">China</option>
                        <option value="CO">Colombia</option>
                        <option value="KM">Comoros</option>
                        <option value="CG">Congo</option>
                        <option value="CD">Congo, Democratic Republic</option>
                        <option value="CR">Costa Rica</option>
                        <option value="HR">Croatia</option>
                        <option value="CU">Cuba</option>
                        <option value="CY">Cyprus</option>
                        <option value="CZ">Czech Republic</option>
                        <option value="DK">Denmark</option>
                        <option value="DJ">Djibouti</option>
                        <option value="DM">Dominica</option>
                        <option value="DO">Dominican Republic</option>
                        <option value="EC">Ecuador</option>
                        <option value="EG">Egypt</option>
                        <option value="SV">El Salvador</option>
                        <option value="GQ">Equatorial Guinea</option>
                        <option value="ER">Eritrea</option>
                        <option value="EE">Estonia</option>
                        <option value="SZ">Eswatini (Swaziland)</option>
                        <option value="ET">Ethiopia</option>
                        <option value="FJ">Fiji</option>
                        <option value="FI">Finland</option>
                        <option value="FR">France</option>
                        <option value="GA">Gabon</option>
                        <option value="GM">Gambia</option>
                        <option value="GE">Georgia</option>
                        <option value="DE">Germany</option>
                        <option value="GH">Ghana</option>
                        <option value="GR">Greece</option>
                        <option value="GD">Grenada</option>
                        <option value="GT">Guatemala</option>
                        <option value="GN">Guinea</option>
                        <option value="GW">Guinea-Bissau</option>
                        <option value="GY">Guyana</option>
                        <option value="HT">Haiti</option>
                        <option value="HN">Honduras</option>
                        <option value="HU">Hungary</option>
                        <option value="IS">Iceland</option>
                        <option value="IN">India</option>
                        <option value="ID">Indonesia</option>
                        <option value="IR">Iran</option>
                        <option value="IQ">Iraq</option>
                        <option value="IE">Ireland</option>
                        <option value="IL">Israel</option>
                        <option value="IT">Italy</option>
                        <option value="JM">Jamaica</option>
                        <option value="JP">Japan</option>
                        <option value="JO">Jordan</option>
                        <option value="KZ">Kazakhstan</option>
                        <option value="KE">Kenya</option>
                        <option value="KI">Kiribati</option>
                        <option value="KP">Korea, Democratic People's Republic</option>
                        <option value="KR">Korea, Republic of</option>
                        <option value="KW">Kuwait</option>
                        <option value="KG">Kyrgyzstan</option>
                        <option value="LA">Lao People's Democratic Republic</option>
                        <option value="LV">Latvia</option>
                        <option value="LB">Lebanon</option>
                        <option value="LS">Lesotho</option>
                        <option value="LR">Liberia</option>
                        <option value="LY">Libya</option>
                        <option value="LI">Liechtenstein</option>
                        <option value="LT">Lithuania</option>
                        <option value="LU">Luxembourg</option>
                        <option value="MG">Madagascar</option>
                        <option value="MW">Malawi</option>
                        <option value="MY">Malaysia</option>
                        <option value="MV">Maldives</option>
                        <option value="ML">Mali</option>
                        <option value="MT">Malta</option>
                        <option value="MH">Marshall Islands</option>
                        <option value="MR">Mauritania</option>
                        <option value="MU">Mauritius</option>
                        <option value="MX">Mexico</option>
                        <option value="FM">Micronesia</option>
                        <option value="MD">Moldova</option>
                        <option value="MC">Monaco</option>
                        <option value="MN">Mongolia</option>
                        <option value="ME">Montenegro</option>
                        <option value="MA">Morocco</option>
                        <option value="MZ">Mozambique</option>
                        <option value="MM">Myanmar</option>
                        <option value="NA">Namibia</option>
                        <option value="NR">Nauru</option>
                        <option value="NP">Nepal</option>
                        <option value="NL">Netherlands</option>
                        <option value="NZ">New Zealand</option>
                        <option value="NI">Nicaragua</option>
                        <option value="NE">Niger</option>
                        <option value="NG">Nigeria</option>
                        <option value="MK">North Macedonia</option>
                        <option value="NO">Norway</option>
                        <option value="OM">Oman</option>
                        <option value="PK">Pakistan</option>
                        <option value="PW">Palau</option>
                        <option value="PA">Panama</option>
                        <option value="PG">Papua New Guinea</option>
                        <option value="PY">Paraguay</option>
                        <option value="PE">Peru</option>
                        <option value="PH">Philippines</option>
                        <option value="PL">Poland</option>
                        <option value="PT">Portugal</option>
                        <option value="QA">Qatar</option>
                        <option value="RO">Romania</option>
                        <option value="RU">Russian Federation</option>
                        <option value="RW">Rwanda</option>
                        <option value="KN">Saint Kitts and Nevis</option>
                        <option value="LC">Saint Lucia</option>
                        <option value="VC">Saint Vincent and the Grenadines</option>
                        <option value="WS">Samoa</option>
                        <option value="SM">San Marino</option>
                        <option value="ST">Sao Tome and Principe</option>
                        <option value="SA">Saudi Arabia</option>
                        <option value="SN">Senegal</option>
                        <option value="RS">Serbia</option>
                        <option value="SC">Seychelles</option>
                        <option value="SL">Sierra Leone</option>
                        <option value="SG">Singapore</option>
                        <option value="SK">Slovakia</option>
                        <option value="SI">Slovenia</option>
                        <option value="SB">Solomon Islands</option>
                        <option value="SO">Somalia</option>
                        <option value="ZA">South Africa</option>
                        <option value="SS">South Sudan</option>
                        <option value="ES">Spain</option>
                        <option value="LK">Sri Lanka</option>
                        <option value="SD">Sudan</option>
                        <option value="SR">Suriname</option>
                        <option value="SE">Sweden</option>
                        <option value="CH">Switzerland</option>
                        <option value="SY">Syrian Arab Republic</option>
                        <option value="TW">Taiwan</option>
                        <option value="TJ">Tajikistan</option>
                        <option value="TZ">Tanzania</option>
                        <option value="TH">Thailand</option>
                        <option value="TL">Timor-Leste</option>
                        <option value="TG">Togo</option>
                        <option value="TO">Tonga</option>
                        <option value="TT">Trinidad and Tobago</option>
                        <option value="TN">Tunisia</option>
                        <option value="TR">Turkey</option>
                        <option value="TM">Turkmenistan</option>
                        <option value="TV">Tuvalu</option>
                        <option value="UG">Uganda</option>
                        <option value="UA">Ukraine</option>
                        <option value="AE">United Arab Emirates</option>
                        <option value="GB">United Kingdom</option>
                        <option value="US">United States of America</option>
                        <option value="UY">Uruguay</option>
                        <option value="UZ">Uzbekistan</option>
                        <option value="VU">Vanuatu</option>
                        <option value="VE">Venezuela</option>
                        <option value="VN">Viet Nam</option>
                        <option value="YE">Yemen</option>
                        <option value="ZM">Zambia</option>
                        <option value="ZW">Zimbabwe</option>

                    </select>
                    {% if form.country.errors %}
                    <div class="invalid-feedback">
                        {{ form.country.errors }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% if user.is_authenticated %}
            <div class="col-12 mb-3">
                <div class="form-check">
                    <input type="checkbox" id="id_save_info" name="save_info" class="form-check-input">
                    <label class="form-check-label" for="id_save_info">Save this delivery information to my
                        profile</label>
                </div>
                {% else %}
                <div class="form-check">
                    <a class="text-info" href="{% url 'account_signup' %}">Create an account</a> or
                    <a class="text-info" href="{% url 'account_login' %}">login</a> to save this information
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Payment Section code block from the Code institue boutique ado walkthrogh -->
        <fieldset class="mb-4">
            <legend class="small text-black px-2">Payment</legend>
            <div class="mb-3" id="card-element">
                <!-- A Stripe card element will go here -->
            </div>
            <!-- Used to display form errors -->
            <div class="mb-3 text-danger" id="card-errors" role="alert"></div>
        </fieldset>

        <div class="d-flex justify-content-between mb-3">
            <a href="{% url 'cart_detail' %}" class="btn btn-outline-success">
                <span class="icon me-2">
                    <i class="fas fa-chevron-left"></i>
                </span>
                <span>Adjust Cart</span>
            </a>
            <button type="submit" class="btn btn-success">Place Order</button>
        </div>

        <p class="small text-danger mb-0">
            <span class="icon me-2">
                <i class="fas fa-exclamation-circle"></i>
            </span>
            <span>Your card will be charged <strong>${{ grand_total|floatformat:2 }}</strong></span>
        </p>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get the Stripe public key and client secret from the template
        const stripePublicKey = "{{ stripe_public_key }}";
        const clientSecret = "{{ client_secret }}";

        // Initialize Stripe
        const stripe = Stripe(stripePublicKey);
        const elements = stripe.elements();

        // Creates an instance of the card Element
        const card = elements.create('card', {
            style: {
                base: {
                    color: '#32325d',
                    fontSize: '16px',
                },
                invalid: {
                    color: '#fa755a',
                }
            }
        });
        card.mount('#card-element');

        // Handle real-time validation errors on the card element
        card.on('change', function (event) {
            const errorElement = document.getElementById('card-errors');
            if (event.error) {
                errorElement.textContent = event.error.message;
            } else {
                errorElement.textContent = '';  // Clear errors when the user corrects them
            }
        });

        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', function (event) {
            event.preventDefault();

            // Get the country code from the form
            const countryCode = document.getElementById('id_country').value;

            // Disable the form to prevent multiple submissions
            form.querySelector('button[type="submit"]').disabled = true;

            // Confirm the payment with Stripe
            stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: card,
                    billing_details: {
                        name: form.full_name.value,
                        email: form.email.value,
                        address: {
                            line1: form.address_line_1.value,
                            line2: form.address_line_2.value,
                            city: form.city.value,
                            postal_code: form.postal_code.value,
                            country: countryCode,
                        }
                    }
                }
            }).then(function (result) {
                if (result.error) {
                    // Show the error to the user
                    const errorElement = document.getElementById('card-errors');
                    errorElement.textContent = result.error.message;

                    // Re-enable the form so the user can try again
                    form.querySelector('button[type="submit"]').disabled = false;
                } else {
                    // The payment was successful!
                    if (result.paymentIntent.status === 'succeeded') {
                        // Submit the form only when payment is successful
                        form.submit();
                    }
                }
            });
        });
    });
</script>
{% endblock %}